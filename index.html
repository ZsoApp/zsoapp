<!doctype html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <title>Zsolt adatb√°zisa</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#050608">

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Zsolt DB">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
<meta name="format-detection" content="telephone=no">

  <style>
    :root{
      --bg0:#050608;
      --bg1:#07080b;
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.55);
      --muted2: rgba(255,255,255,0.40);
      --shadow: 0 30px 80px rgba(0,0,0,0.55);
      --r3: 28px;
      --ease: cubic-bezier(.16,1,.3,1);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(180,200,255,0.08), transparent 55%),
        radial-gradient(900px 700px at 75% 30%, rgba(255,255,255,0.05), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }
    .noise{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:0.10;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
    }
    .app{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
    }
    .stage{
      width:min(1180px, 96vw);
      height:min(780px, 92vh);
      position:relative;
      border-radius: 34px;
      background: rgba(0,0,0,0.18);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.06);
      overflow:hidden;
    }
    .stage::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), transparent 18%);
      opacity:0.45;
      pointer-events:none;
    }

    /* Views */
    .view{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 26px;
      opacity:0;
      transform: translateY(14px);
      filter: blur(8px);
      transition: opacity 420ms var(--ease), transform 420ms var(--ease), filter 420ms var(--ease);
      pointer-events:none;
    }
    .view.active{
      opacity:1;
      transform: translateY(0);
      filter: blur(0);
      pointer-events:auto;
    }
    .view.zoom-enter{
      opacity:1;
      transform: scale(0.92);
      filter: blur(10px);
      transition: opacity 520ms var(--ease), transform 520ms var(--ease), filter 520ms var(--ease);
    }
    .view.zoom-enter.active{
      transform: scale(1);
      filter: blur(0);
    }

    /* Splash */
    .splashWrap{ width:100%; max-width: 900px; text-align:center; }
    .kicker{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .38em;
      text-transform: uppercase;
      color: var(--muted2);
      margin-bottom: 14px;
    }
    .title{
      font-size: clamp(38px, 6vw, 64px);
      font-weight: 650;
      letter-spacing: -0.02em;
      margin:0;
      line-height: 1.05;
      background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0.65), rgba(255,255,255,0.40));
      -webkit-background-clip: text;
      background-clip:text;
      color: transparent;
      text-shadow: 0 0 35px rgba(255,255,255,0.06);
    }
    .splashEnter{
      opacity:0;
      transform: translateY(84px);
      filter: blur(12px);
      animation: rise 900ms var(--ease) forwards;
    }
    @keyframes rise{ to{ opacity:1; transform: translateY(0); filter: blur(0); } }
    .bar{
      margin: 34px auto 0;
      width: 180px;
      height: 5px;
      border-radius:999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      width:100%;
      height:100%;
      background: rgba(255,255,255,0.42);
      transform: translateX(-100%);
      animation: load 1000ms ease-in-out forwards;
      animation-delay: 620ms;
    }
    @keyframes load{ to{ transform: translateX(0%); } }

    /* Mode Select */
    .modeWrap{ width:100%; max-width: 980px; }
    .centerHead{ text-align:center; margin-bottom: 18px; }
    .centerHead .small{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .36em;
      text-transform: uppercase;
      color: var(--muted2);
    }
    .centerHead .big{
      margin: 10px 0 0;
      font-size: clamp(26px, 3.2vw, 40px);
      font-weight: 650;
      letter-spacing: -0.02em;
    }
    .cards{
      margin-top: 26px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 760px){ .cards{ grid-template-columns: 1fr; } }
    .card{
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.24);
      backdrop-filter: blur(14px);
      padding: 22px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.02) inset;
      cursor:pointer;
      transition: transform 220ms var(--ease), border-color 220ms var(--ease), background 220ms var(--ease);
      position:relative;
      overflow:hidden;
      text-align:left;
    }
    .card::before{
      content:"";
      position:absolute; inset:-40% -40%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.10), transparent 55%);
      opacity:0.55;
      transform: translateY(8px);
      transition: opacity 220ms var(--ease);
      pointer-events:none;
    }
    .card:hover{
      transform: scale(1.02);
      border-color: rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.28);
    }
    .card:hover::before{ opacity:0.75; }
    .cardTop{ display:flex; gap: 14px; align-items:flex-start; }
    .icon{
      width: 52px; height: 52px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      font-size: 24px;
      flex: 0 0 auto;
    }
    .cardTitle{
      font-size: 20px;
      font-weight: 650;
      letter-spacing: -0.01em;
      margin:0;
    }
    .cardSub{
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.45;
    }
    .divider{
      margin-top: 18px;
      height:1px;
      background: linear-gradient(90deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06), transparent);
      opacity:0.8;
    }
    .enter{
      margin-top: 14px;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .28em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.42);
      transition: color 220ms var(--ease);
    }
    .card:hover .enter{ color: rgba(255,255,255,0.72); }
    .foot{
      margin-top: 18px;
      text-align:center;
      font-size: 12px;
      color: var(--muted2);
    }

    /* Buttons */
    .addRow{
      margin-top: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .addFab{
      position:relative;
      width: 64px; height: 64px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(14px);
      cursor:pointer;
      transition: transform 220ms var(--ease), border-color 220ms var(--ease), background 220ms var(--ease);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.02) inset;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .addFab:hover{ transform: scale(1.03); border-color: rgba(255,255,255,0.18); background: rgba(255,255,255,0.06); }
    .addFab:active{ transform: scale(0.98); }
    .addFab::before{
      content:"";
      position:absolute; inset:-60% -60%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.16), transparent 55%);
      opacity:0.55;
      pointer-events:none;
    }
    .addFab span{ font-family: var(--mono); font-size: 26px; color: rgba(255,255,255,0.85); }
    .addHint{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.46);
      user-select:none;
    }

    /* Tunnel */
    .tunnel{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity 520ms var(--ease);
      background:
        radial-gradient(140px 140px at var(--x, 50%) var(--y, 50%), rgba(255,255,255,0.12), transparent 65%),
        radial-gradient(520px 520px at var(--x, 50%) var(--y, 50%), rgba(255,255,255,0.10), transparent 70%),
        radial-gradient(1000px 1000px at var(--x, 50%) var(--y, 50%), rgba(0,0,0,0.75), rgba(0,0,0,0.95));
    }
    .tunnel.on{ opacity:1; }

    /* Panels */
    .panel{
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      backdrop-filter: blur(14px);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .panelHead{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      flex: 0 0 auto;
    }
    .panelHead .cap{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .30em;
      text-transform: uppercase;
      color: var(--muted2);
    }
    .panelHead .h{
      margin-top: 8px;
      font-size: 16px;
      font-weight: 650;
      letter-spacing: -0.01em;
    }
    .panelBody{
      padding: 12px;
      overflow:auto;
      max-height: 100%;
      flex: 1 1 auto;
      min-height:0;
    }

    /* extra scroll space so last item is always visible */
    .scrollPad{ padding-bottom: 64px !important; }

    /* Topbar */
    .topbar{
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 18px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.20);
      backdrop-filter: blur(14px);
      gap: 12px;
    }
    .brand{ display:flex; align-items:center; gap: 12px; min-width: 0; }
    .brandBadge{
      width:42px;height:42px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      display:flex; align-items:center; justify-content:center;
      font-size: 18px;
      flex: 0 0 auto;
    }
    .brandText{ min-width:0; }
    .brandText .small{ font-size: 12px; color: var(--muted2); }
    .brandText .big{ font-size: 16px; font-weight: 650; margin-top: 2px; letter-spacing: -0.01em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .actions{ display:flex; gap: 10px; flex-wrap: wrap; justify-content:flex-end; align-items:center; }
    .btn{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.86);
      padding: 10px 14px;
      font-size: 13px;
      cursor:pointer;
      transition: background 200ms var(--ease), border-color 200ms var(--ease), transform 200ms var(--ease);
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.14); }
    .btn:active{ transform: scale(0.98); }

    /* segmented */
    .seg{
      display:flex;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      overflow:hidden;
    }
    .seg button{
      border:0;
      background:transparent;
      color: rgba(255,255,255,0.70);
      padding: 10px 12px;
      font-size: 13px;
      cursor:pointer;
      transition: background 200ms var(--ease), color 200ms var(--ease);
      display:flex; align-items:center; gap:8px;
    }
    .seg button:hover{ background: rgba(255,255,255,0.05); }
    .seg button.active{
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
    }

    /* Toggle chips */
    .togRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      margin-top: 10px;
    }
    .tog{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.88);
      padding: 12px 14px;
      cursor:pointer;
      transition: background 180ms var(--ease), border-color 180ms var(--ease), transform 180ms var(--ease);
      display:flex;
      align-items:center;
      gap: 10px;
      user-select:none;
    }
    .tog:hover{ background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.14); transform: translateY(-1px); }
    .tog:active{ transform: scale(0.99); }
    .tog .k{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.50);
    }
    .tog .v{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.92);
    }
    .togMini{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.86);
      padding: 10px 12px;
      cursor:pointer;
      font-size: 13px;
      transition: background 180ms var(--ease), border-color 180ms var(--ease);
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .togMini:hover{ background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.14); }

    /* Inputs */
    .field{ display:flex; flex-direction:column; gap: 8px; margin-top: 10px; }
    label{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .26em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.46);
    }
    input{
      width:100%;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.90);
      padding: 12px 14px;
      font-size: 14px;
      outline:none;
      transition: border-color 200ms var(--ease), background 200ms var(--ease);
    }
    input:focus{
      border-color: rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.04);
    }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 560px){ .row2{ grid-template-columns: 1fr; } }

    .pillRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .pill{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.45);
    }
    .danger{
      border-color: rgba(255,80,80,0.35) !important;
      background: rgba(255,80,80,0.06) !important;
    }
    .smallNote{
      font-size: 12px;
      color: rgba(255,255,255,0.46);
      line-height: 1.5;
      margin-top: 10px;
    }
    .paperLine{
      height:1px;
      background: linear-gradient(90deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06), transparent);
      opacity:0.85;
      margin: 12px 0;
    }

    /* LIST VIEW */
    .paperWrap{ width:100%; height:100%; display:flex; flex-direction:column; min-height:0; }
    .paperGrid{ flex:1 1 auto; display:grid; grid-template-columns: 1fr 360px; gap:14px; padding:14px; min-height:0; }
    @media (max-width: 980px){ .paperGrid{ grid-template-columns: 1fr; } }
    .paperPanel{
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,0.10);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03)),
        rgba(0,0,0,0.10);
      backdrop-filter: blur(14px);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .paperBody{ padding: 16px 18px; overflow:auto; flex:1 1 auto; min-height:0; padding-bottom:34px; }
    .paperItem{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      padding: 10px 10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.14);
      position:relative;
      transform: translateY(0);
      transition: transform 180ms var(--ease), background 180ms var(--ease), border-color 180ms var(--ease);
      user-select:none;
    }
    .paperItem + .paperItem{ margin-top: 10px; }
    .paperItem:hover{
      transform: translateY(-3px);
      background: rgba(255,255,255,0.03);
      border-color: rgba(255,255,255,0.12);
    }
    .paperItem.done{ opacity:0.62; }
    .paperItem.done::after{
      content:"";
      position:absolute;
      left: 42px;
      right: 72px;
      top: 22px;
      height:1px;
      background: rgba(255,255,255,0.45);
      pointer-events:none;
    }
    .paperItem.hold{
      border-color: rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.04);
      transform: translateY(-2px) scale(0.995);
    }
    .dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.06);
      margin-top: 6px;
      flex: 0 0 auto;
    }
    .paperText{ flex: 1 1 auto; min-width: 0; }
    .paperTitle{
      font-size: 15px;
      font-weight: 650;
      letter-spacing: -0.01em;
      line-height: 1.25;
      word-break: break-word;
    }
    .paperMeta{
      margin-top: 6px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      color: rgba(255,255,255,0.54);
      font-size: 12px;
      font-family: var(--mono);
      letter-spacing: .10em;
      text-transform: uppercase;
    }
    .chip{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.52);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      padding: 5px 10px;
      border-radius: 999px;
    }
    .paperDel{
      border-radius: 999px;
      border: 1px solid rgba(255,80,80,0.35);
      background: rgba(255,80,80,0.06);
      color: rgba(255,255,255,0.75);
      padding: 6px 10px;
      font-size: 11px;
      font-family: var(--mono);
      letter-spacing: .18em;
      text-transform: uppercase;
      cursor:pointer;
      transition: transform 200ms var(--ease), background 200ms var(--ease);
      flex: 0 0 auto;
      align-self:flex-start;
    }
    .paperDel:hover{ background: rgba(255,80,80,0.10); }
    .paperDel:active{ transform: scale(0.98); }

    /* ADD */
    .formWrap{ width:100%; max-width: 980px; height:100%; display:flex; flex-direction:column; gap:14px; min-height:0; }
    .formGrid{ flex:1 1 auto; display:grid; grid-template-columns: 1fr 420px; gap:14px; min-height:0; }
    @media (max-width: 980px){ .formGrid{ grid-template-columns: 1fr; } }

    /* CALENDAR */
    .calWrap{ width:100%; height:100%; display:flex; flex-direction:column; min-height:0; }
    .calGrid{ flex:1 1 auto; display:grid; grid-template-columns: 1fr 420px; gap:14px; padding:14px; min-height:0; }
    @media (max-width: 980px){ .calGrid{ grid-template-columns: 1fr; } }

    /* Week stack: range bars + day grid */
    .weekStack{ display:flex; flex-direction:column; gap:12px; }

    .rangeLayer{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      align-items:stretch;
    }
    .rangeBar{
      height: 42px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      overflow:hidden;
      cursor: default;
    }
    .rangeBar .t{
      font-size: 12px;
      font-weight: 650;
      letter-spacing: -0.01em;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .rangeBar .m{
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.55);
      white-space: nowrap;
      flex: 0 0 auto;
    }

    /* ‚úÖ FEJLESZT√âS: minden nap doboza legyen akkora, mint a legnagyobb */
    .weekWide{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      align-items:stretch; /* <- ett≈ël egy sorban mind ugyanakkora magass√°g lesz */
    }

    .dayWide{
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding: 12px;
      cursor:pointer;
      transition: transform 180ms var(--ease), background 180ms var(--ease), border-color 180ms var(--ease);
      position:relative;

      display:flex;
      flex-direction:column;

      min-height: 260px;
      height: 100%; /* <- a grid sor magass√°g√°t felveszi (a legmagasabb naphoz igazodik) */
      overflow: hidden;
    }
    .dayWide:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.03);
    }
    .dayWide.sel{
      border-color: rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.04);
    }
    .dayWide.today{
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset;
    }
    .dayWideTop{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      padding: 0 2px;
      margin-bottom: 10px;
      position: relative;
      z-index: 2;
      flex: 0 0 auto;
    }
    .dayWideTop .w{
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      font-family: var(--mono);
      letter-spacing: .12em;
      text-transform: uppercase;
    }
    .dayWideTop .d{
      font-size: 12px;
      color: rgba(255,255,255,0.44);
      font-family: var(--mono);
    }

    .miniPill{
      position:absolute;
      right: 10px;
      bottom: 10px;
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.45);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      padding: 6px 10px;
      border-radius: 999px;
    }
    .calTask{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      padding: 10px;
      margin-top: 8px;
      transition: transform 180ms var(--ease), background 180ms var(--ease), border-color 180ms var(--ease);
      flex: 0 0 auto;
    }
    .calTask:hover{
      transform: translateY(-2px);
      background: rgba(255,255,255,0.03);
      border-color: rgba(255,255,255,0.14);
    }
    .calTask .t{
      font-size: 13px;
      font-weight: 650;
      letter-spacing: -0.01em;
      line-height:1.25;
      word-break: break-word;
    }
    .calTask .m{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(255,255,255,0.50);
      font-family: var(--mono);
      letter-spacing:.08em;
      text-transform: uppercase;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .calTask .del{
      margin-top: 8px;
      display:inline-block;
      border-radius: 999px;
      border: 1px solid rgba(255,80,80,0.35);
      background: rgba(255,80,80,0.06);
      color: rgba(255,255,255,0.72);
      padding: 6px 10px;
      font-size: 11px;
      font-family: var(--mono);
      letter-spacing: .18em;
      text-transform: uppercase;
      cursor:pointer;
    }
    .calTask .del:hover{ background: rgba(255,80,80,0.10); }

    /* overlays */
    .overlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(14px);
      opacity:0;
      pointer-events:none;
      transition: opacity 220ms var(--ease);
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .overlay.on{ opacity:1; pointer-events:auto; }
    .overlayCard{
      width:100%;
      height:100%;
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.30);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow: 0 30px 90px rgba(0,0,0,0.55);
    }

    /* Day fullscreen view (06‚Äì22, bigger spacing) */
    .dayViewGrid{ flex:1 1 auto; display:grid; grid-template-columns: 1fr 420px; gap:14px; padding:14px; min-height:0; }
    @media (max-width: 980px){ .dayViewGrid{ grid-template-columns: 1fr; } }
    .timeline{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .timelineHead{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
    }
    .timelineHead .big{ font-size: 16px; font-weight: 650; letter-spacing: -0.01em; }
    .timelineHead .small{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.46);
      white-space:nowrap;
    }
    .timelineBody{
      flex:1 1 auto;
      overflow:auto;
      position:relative;
      padding: 14px 12px 28px;
      min-height:0;
    }
    .hourRow{
      position:relative;
      height: 76px;
      border-top: 1px solid rgba(255,255,255,0.06);
      display:flex;
      align-items:flex-start;
      gap: 10px;
      padding-top: 10px;
    }
    .hourLabel{
      width: 64px;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.45);
      flex: 0 0 auto;
      padding-left: 4px;
    }
    .hourLine{ flex:1 1 auto; height:1px; background: rgba(255,255,255,0.06); margin-top: 10px; }
    .taskBlocks{
      position:absolute;
      left: 96px;
      right: 12px;
      top: 14px;
      bottom: 28px;
      pointer-events:none;
    }
    .blockTask{
      position:absolute;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      padding: 10px 10px;
      pointer-events:auto;
      overflow:hidden;
    }
    .blockTask .t{ font-size: 13px; font-weight: 650; letter-spacing:-0.01em; line-height:1.2; word-break: break-word; }
    .blockTask .m{
      margin-top: 6px;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.55);
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .blockTask .del{
      margin-top: 8px;
      display:inline-block;
      border-radius: 999px;
      border: 1px solid rgba(255,80,80,0.35);
      background: rgba(255,80,80,0.06);
      color: rgba(255,255,255,0.72);
      padding: 6px 10px;
      font-size: 11px;
      font-family: var(--mono);
      letter-spacing: .18em;
      text-transform: uppercase;
      cursor:pointer;
    }
    .blockTask .del:hover{ background: rgba(255,80,80,0.10); }

    /* Month picker tiles */
    .monthGrid{ flex:1 1 auto; display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; padding:14px; overflow:auto; }
    @media (max-width: 980px){ .monthGrid{ grid-template-columns: repeat(2, 1fr); } }
    .monthTile{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      padding: 16px;
      cursor:pointer;
      transition: transform 180ms var(--ease), background 180ms var(--ease), border-color 180ms var(--ease);
      position:relative;
      overflow:hidden;
      min-height: 96px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .monthTile:hover{
      transform: translateY(-2px);
      background: rgba(255,255,255,0.04);
      border-color: rgba(255,255,255,0.14);
    }
    .monthTile .m1{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.46);
    }
    .monthTile .m2{ margin-top: 8px; font-size: 18px; font-weight: 650; letter-spacing: -0.01em; }
    .monthTile .m3{
      margin-top: 10px;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.55);
    }
    .monthTile.current{ border-color: rgba(255,255,255,0.18); background: rgba(255,255,255,0.05); }
  
    /* =========================
       iPhone / PWA portrait UX
       ========================= */
    @media (max-width: 520px) and (orientation: portrait){
      body{ overflow:hidden; }
      .app{ padding:0; }
      .stage{
        width:100vw;
        height:100dvh; /* better on iOS */
        border-radius: 0;
      }
      .view{ padding: 14px; }
      .topbar{
        padding: 12px 12px;
        gap: 10px;
      }
      .brandBadge{ width:40px; height:40px; border-radius: 16px; }
      .brandText .small{ font-size: 11px; }
      .brandText .big{ font-size: 15px; }
      .actions{ width:100%; justify-content:flex-start; }
      .btn{
        padding: 12px 14px;
        font-size: 14px;
        border-radius: 16px;
      }
      .seg{ width:100%; }
      .seg button{ padding: 11px 12px; font-size: 14px; }
      .paperGrid, .formGrid, .calGrid, .dayViewGrid{
        grid-template-columns: 1fr !important;
        padding: 12px !important;
        gap: 12px !important;
      }
      .panelHead{ padding: 12px 12px 10px; }
      .panelBody{ padding: 12px; }
      .paperBody{ padding: 14px 14px; }
      .paperItem{ padding: 12px 12px; }
      .paperTitle{ font-size: 16px; }
      .paperMeta{ font-size: 12px; }
      .addRow{ gap: 10px; }
      .addFab{ width: 60px; height: 60px; border-radius: 22px; }
      /* Safe-area padding for notch + home bar */
      .topbar{ padding-top: calc(12px + env(safe-area-inset-top)); }
      .panelBody.scrollPad, .paperBody, .timelineBody, .monthGrid{
        padding-bottom: calc(72px + env(safe-area-inset-bottom)) !important;
      }
    }

    /* Allow full safe-area usage */
    @supports(padding:max(0px)){
      .stage{ padding-bottom: env(safe-area-inset-bottom); }
    }

  </style>
</head>
<body>
  <div class="noise"></div>

  <div class="app">
    <div class="stage">
      <div class="tunnel" id="tunnel"></div>

      <!-- overlays -->
      <div class="overlay" id="overlayDay">
        <div class="overlayCard">
          <div class="topbar">
            <div class="brand">
              <div class="brandBadge">üóìÔ∏è</div>
              <div class="brandText">
                <div class="small">Napi n√©zet</div>
                <div class="big" id="dayViewTitle">‚Äî</div>
              </div>
            </div>
            <div class="actions">
              <button class="btn" id="btnDayClose">Bez√°r</button>
            </div>
          </div>

          <div class="dayViewGrid">
            <div class="timeline">
              <div class="timelineHead">
                <div class="big">Id≈ës√°v (06‚Äì22)</div>
                <div class="small" id="dayViewMeta">‚Äî</div>
              </div>
              <div class="timelineBody" id="timelineBody">
                <div class="taskBlocks" id="taskBlocks"></div>
              </div>
            </div>

            <div class="panel">
              <div class="panelHead">
                <div class="cap">feladatok</div>
                <div class="h">Aznapi lista (id≈ë szerint)</div>
              </div>
              <div class="panelBody scrollPad" id="dayTaskList"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="overlay" id="overlayMonths">
        <div class="overlayCard">
          <div class="topbar">
            <div class="brand">
              <div class="brandBadge">üß≠</div>
              <div class="brandText">
                <div class="small">Napt√°r</div>
                <div class="big">H√≥napv√°laszt√≥</div>
              </div>
            </div>
            <div class="actions">
              <button class="btn" id="btnMonthsClose">Bez√°r</button>
            </div>
          </div>
          <div class="monthGrid" id="monthGrid"></div>
        </div>
      </div>

      <!-- SPLASH -->
      <section class="view active" id="view-splash">
        <div class="splashWrap">
          <div class="kicker splashEnter">offline ‚Ä¢ local ‚Ä¢ private</div>
          <h1 class="title splashEnter" style="animation-delay: 80ms;">Zsolt adatb√°zisa</h1>
          <div class="bar" aria-hidden="true"><i></i></div>
        </div>
      </section>

      <!-- MODE SELECT -->
      <section class="view" id="view-mode">
        <div class="modeWrap">
          <div class="centerHead">
            <div class="small">v√°lassz ter√ºletet</div>
            <div class="big">Melyik m√≥dba l√©psz be?</div>
          </div>

          <div class="cards">
            <div class="card" role="button" tabindex="0" data-mode="business">
              <div class="cardTop">
                <div class="icon">üíº</div>
                <div>
                  <p class="cardTitle">V√°llalkoz√°s</p>
                  <div class="cardSub">lista priorit√°s szerint, hat√°rid≈ëkkel</div>
                  <div class="divider"></div>
                  <div class="enter">Enter</div>
                </div>
              </div>
            </div>

            <div class="card" role="button" tabindex="0" data-mode="personal">
              <div class="cardTop">
                <div class="icon">üåø</div>
                <div>
                  <p class="cardTitle">Mag√°n√©let</p>
                  <div class="cardSub">lista priorit√°s szerint, hat√°rid≈ëkkel</div>
                  <div class="divider"></div>
                  <div class="enter">Enter</div>
                </div>
              </div>
            </div>
          </div>

          <div class="addRow">
            <button class="addFab" id="btnAddFab" aria-label="Feladat hozz√°ad√°sa">
              <span>Ôºã</span>
            </button>
            <div class="addHint">Feladat (lista)</div>

            <button class="addFab" id="btnOpenCalendar" aria-label="Napt√°r">
              <span>üìÖ</span>
            </button>
            <div class="addHint">Napt√°r</div>
          </div>

          <div class="foot">Lista √©s napt√°r k√ºl√∂n adatb√°zis. A napt√°r ‚Äúmai‚Äù feladatai automatikusan felmennek a list√°ra.</div>
        </div>
      </section>

      <!-- LIST VIEW -->
      <section class="view" id="view-list">
        <div class="paperWrap">
          <div class="topbar">
            <div class="brand">
              <div class="brandBadge" id="listModeIcon">üåø</div>
              <div class="brandText">
                <div class="small">Zsolt adatb√°zisa</div>
                <div class="big" id="listModeLabel">Mag√°n√©let</div>
              </div>
            </div>

            <div class="actions">
              <div class="seg" title="Gyors v√°lt√°s">
                <button id="segBusiness"><span>üíº</span><span>V√°ll.</span></button>
                <button id="segPersonal"><span>üåø</span><span>Mag√°n</span></button>
              </div>

              <button class="btn" id="btnListAdd">Ôºã Feladat</button>
              <button class="btn" id="btnListCalendar">Napt√°r</button>
              <button class="btn" id="btnListBack">Kezd≈ëlap</button>
            </div>
          </div>

          <div class="paperGrid">
            <div class="paperPanel">
              <div class="panelHead">
                <div class="cap">lista</div>
                <div class="h">Feladatok (priorit√°s szerint)</div>
              </div>
              <div class="paperBody" id="paperList"></div>
            </div>

            <div class="panel">
              <div class="panelHead">
                <div class="cap">szab√°ly</div>
                <div class="h">K√©sz + napt√°r sync</div>
              </div>
              <div class="panelBody scrollPad">
                <div class="smallNote">
                  ‚Ä¢ Hossz√∫ nyom√°s (0.55 mp) ‚Üí k√©sz (√°th√∫z√°s)<br/>
                  ‚Ä¢ A k√©sz feladatok √©jf√©l ut√°n elt≈±nnek<br/>
                  ‚Ä¢ A napt√°r ‚Äúmai‚Äù feladatai automatikusan felmennek a list√°ra (a napt√°rban v√°lasztod: v√°ll./mag√°n).
                </div>
                <div class="paperLine"></div>
                <div class="smallNote" id="countNote"></div>
                <button class="btn" id="btnClearAll" style="margin-top:12px;">√ñsszes t√∂rl√©se (csak ebben a m√≥dban)</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ADD TASK (LIST DB ONLY) -->
      <section class="view zoom-enter" id="view-add">
        <div class="formWrap">
          <div class="topbar" style="border-bottom:1px solid rgba(255,255,255,0.08); border-radius: 26px;">
            <div class="brand">
              <div class="brandBadge">Ôºã</div>
              <div class="brandText">
                <div class="small">Zsolt adatb√°zisa</div>
                <div class="big">Feladat hozz√°ad√°sa (lista)</div>
              </div>
            </div>
            <div class="actions">
              <button class="btn" id="btnAddBack">Vissza</button>
              <button class="btn" id="btnToCalendarFromAdd">Napt√°r</button>
            </div>
          </div>

          <div class="formGrid">
            <div class="panel">
              <div class="panelHead">
                <div class="cap">bevitel</div>
                <div class="h">√öj lista-feladat</div>
              </div>
              <div class="panelBody scrollPad" style="padding:14px;">
                <div class="pillRow">
                  <div class="pill">lista adatb√°zis ‚Ä¢ localStorage</div>
                  <div class="pill" id="modePill">m√≥d: ‚Äî</div>
                </div>

                <div class="field">
                  <label for="tTitle">C√≠m</label>
                  <input id="tTitle" placeholder="Pl.: √Åraj√°nlat / Edz√©s / H√≠v√°s" />
                </div>

                <div class="togRow">
                  <button class="tog" id="togListMode" type="button" title="Kattint√°sra v√°lt">
                    <span class="k">ter√ºlet</span><span class="v" id="togListModeV">üåø MAG√ÅN</span>
                  </button>
                  <button class="tog" id="togListPrio" type="button" title="Kattint√°sra v√°lt">
                    <span class="k">prio</span><span class="v" id="togListPrioV">P2</span>
                  </button>
                </div>

                <div class="row2">
                  <div class="field">
                    <label for="tTime">Id≈ë (hat√°rid≈ë)</label>
                    <input id="tTime" type="time" />
                  </div>
                  <div class="field">
                    <label for="tDate">D√°tum (hat√°rid≈ë)</label>
                    <input id="tDate" type="date" />
                  </div>
                </div>

                <div class="row2" style="align-items:end; margin-top:12px;">
                  <button class="btn" id="btnSaveTask" style="padding:12px 14px;">Ment√©s</button>
                  <button class="btn" id="btnClearForm" style="padding:12px 14px;">T√∂rl√©s</button>
                </div>

                <div class="smallNote" id="autoP1Note"></div>
              </div>
            </div>

            <div class="panel">
              <div class="panelHead">
                <div class="cap">gyorsment√©s</div>
                <div class="h">Enter</div>
              </div>
              <div class="panelBody scrollPad">
                <div class="smallNote">
                  ‚Ä¢ C√≠m mez≈ëben Enter ‚Üí ment√©s<br/>
                  ‚Ä¢ Id≈ë mez≈ëben Enter ‚Üí ment√©s<br/>
                  ‚Ä¢ Ment√©s gomb megmarad
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- CALENDAR VIEW -->
      <section class="view" id="view-calendar">
        <div class="calWrap">
          <div class="topbar">
            <div class="brand">
              <div class="brandBadge">üìÖ</div>
              <div class="brandText">
                <div class="small">Zsolt adatb√°zisa</div>
                <div class="big" id="calTitle">Napt√°r</div>
              </div>
            </div>
            <div class="actions">
              <button class="btn" id="btnCalToList">Lista</button>
              <button class="btn" id="btnCalHome">Kezd≈ëlap</button>
            </div>
          </div>

          <div class="calGrid">
            <div class="panel">
              <div class="panelHead" style="display:flex; align-items:flex-end; justify-content:space-between; gap:10px;">
                <div>
                  <div class="cap">napt√°r</div>
                  <div class="h" id="calWeekLabel">Heti n√©zet</div>
                </div>
                <div class="actions" style="gap:8px;">
                  <button class="btn" id="btnPrevWeek">‚óÄ</button>
                  <button class="btn" id="btnTodayMonth">Ma</button>
                  <button class="btn" id="btnNextWeek">‚ñ∂</button>
                </div>
              </div>

              <div class="panelBody scrollPad">
                <div class="weekStack">
                  <div class="rangeLayer" id="rangeLayer"></div>
                  <div class="weekWide" id="weekWide"></div>
                </div>
              </div>
            </div>

            <div class="panel">
              <div class="panelHead">
                <div class="cap">bevitel</div>
                <div class="h">Napt√°r-feladat</div>
              </div>
              <div class="panelBody scrollPad" style="padding:14px;">
                <div class="pillRow">
                  <div class="pill">napt√°r adatb√°zis ‚Ä¢ localStorage</div>
                  <div class="pill" id="selDatePill">d√°tum: ‚Äî</div>
                </div>

                <div class="field">
                  <label for="cTitle">C√≠m</label>
                  <input id="cTitle" placeholder="Pl.: Tal√°lkoz√≥ / Bev√°s√°rl√°s / Munka blokk" />
                </div>

                <div class="row2">
                  <div class="field">
                    <label for="cTime">Id≈ë (rendez√©s)</label>
                    <input id="cTime" type="time" />
                  </div>
                  <div class="field">
                    <label for="cDate">D√°tum</label>
                    <input id="cDate" type="date" />
                  </div>
                </div>

                <div class="togRow">
                  <button class="tog" id="togCalMode" type="button" title="Kattint√°sra v√°lt">
                    <span class="k">lista</span><span class="v" id="togCalModeV">üåø MAG√ÅN</span>
                  </button>

                  <button class="togMini" id="btnMultiToggle" type="button" title="Id≈ëszak felv√©tele">
                    üìÜ T√∂bb nap
                  </button>

                  <div id="multiPanel" style="display:none; width:100%;">
                    <div class="row2" style="margin-top:10px;">
                      <div class="field">
                        <label for="cFrom">-t√≥l (d√°tum)</label>
                        <input id="cFrom" type="date" />
                      </div>
                      <div class="field">
                        <label for="cTo">-ig (d√°tum)</label>
                        <input id="cTo" type="date" />
                      </div>
                    </div>
                    <div class="smallNote">T√∂bb napos esem√©ny ‚Üí a napt√°rban fel√ºl folyamatos s√°v lesz.</div>
                  </div>
                </div>

                <div class="row2" style="align-items:end; margin-top:12px;">
                  <button class="btn" id="btnCalAddTask" style="padding:12px 14px;">Ment√©s</button>
                  <button class="btn" id="btnCalClear" style="padding:12px 14px;">T√∂rl√©s</button>
                </div>

                <div class="paperLine"></div>
                <div class="pill" style="margin-top:6px;">Kijel√∂lt nap feladatai (id≈ë szerint)</div>
                <div id="calDayTasks" style="margin-top:10px;"></div>

                <div class="smallNote" id="calSyncNote"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <script>
    // -------------------------
    // Views + state
    // -------------------------
    const views = {
      splash: document.getElementById("view-splash"),
      mode: document.getElementById("view-mode"),
      list: document.getElementById("view-list"),
      add: document.getElementById("view-add"),
      calendar: document.getElementById("view-calendar"),
    };
    function show(name){
      Object.values(views).forEach(v => v.classList.remove("active"));
      views[name].classList.add("active");
    }
    let currentMode = "personal";
    setTimeout(() => show("mode"), 1700);

    // -------------------------
    // Storage keys
    // -------------------------
    const LS_LIST_KEY = "zsolt_db_tasks_list_v7";
    const LS_CAL_KEY  = "zsolt_db_tasks_calendar_v4";
    const LS_DAY_KEY  = "zsolt_db_last_day_v7";

    // -------------------------
    // Helpers
    // -------------------------
    function uid(){
      return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function todayYMD(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function isTodayDate(ymd){ return !!ymd && ymd === todayYMD(); }
    function modeLabel(mode){ return mode === "business" ? "V√°llalkoz√°s" : "Mag√°n√©let"; }
    function modeIcon(mode){ return mode === "business" ? "üíº" : "üåø"; }

    function priorityRank(p){
      if(p === "P1") return 1;
      if(p === "P2") return 2;
      return 3;
    }
    function dueStamp(task){
      const d = task.date || "9999-12-31";
      const t = task.time && task.time.trim() ? task.time : "23:59";
      return `${d}T${t}:00`;
    }
    function fmtDue(task){
      const d = task.date ? task.date : "‚Äî";
      const t = task.time && task.time.trim() ? task.time : "";
      return t ? `${d} ${t}` : d;
    }

    // Date helpers
    function parseYMD(ymd){
      const [y,m,d] = ymd.split("-").map(n=>parseInt(n,10));
      return new Date(y, m-1, d);
    }
    function ymdOf(dateObj){
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,"0");
      const d = String(dateObj.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
    function cmpYMD(a,b){ return a < b ? -1 : (a > b ? 1 : 0); }
    function clampRange(from,to){
      if(!from) return {from:null,to:null};
      if(!to) return {from, to:from};
      if(cmpYMD(from,to) <= 0) return {from,to};
      return {from:to, to:from};
    }

    // -------------------------
    // LIST DB
    // -------------------------
    function loadListTasks(){
      try{
        const raw = localStorage.getItem(LS_LIST_KEY);
        if(!raw) return [];
        const x = JSON.parse(raw);
        return Array.isArray(x) ? x : [];
      }catch{ return []; }
    }
    function saveListTasks(tasks){
      localStorage.setItem(LS_LIST_KEY, JSON.stringify(tasks));
    }
    function purgeListDoneFromPreviousDays(){
      const today = todayYMD();
      const tasks = loadListTasks();
      const kept = tasks.filter(t => !(t.done === true && t.doneAt && t.doneAt !== today));
      if(kept.length !== tasks.length) saveListTasks(kept);
      localStorage.setItem(LS_DAY_KEY, today);
      return kept;
    }
    function tickDayChange(){
      const today = todayYMD();
      const last = localStorage.getItem(LS_DAY_KEY);
      if(last && last !== today){
        purgeListDoneFromPreviousDays();
        syncCalendarTodayToList();
        if(views.list.classList.contains("active")) renderList();
      } else if(!last) {
        localStorage.setItem(LS_DAY_KEY, today);
      }
    }
    purgeListDoneFromPreviousDays();
    setInterval(tickDayChange, 45 * 1000);

    // -------------------------
    // CAL DB (single + range)
    // -------------------------
    function normalizeCalEvent(e){
      if(!e || typeof e !== "object") return null;
      const type = e.type || "single";
      if(type === "range"){
        if(!e.from || !e.to) return null;
        const r = clampRange(e.from, e.to);
        return {
          id: e.id || uid(),
          type: "range",
          title: String(e.title||"").trim(),
          from: r.from,
          to: r.to,
          time: String(e.time||"").trim(),
          mode: e.mode || "personal",
          createdAt: e.createdAt || Date.now()
        };
      }
      if(!e.date) return null;
      return {
        id: e.id || uid(),
        type: "single",
        title: String(e.title||"").trim(),
        date: e.date,
        time: String(e.time||"").trim(),
        mode: e.mode || "personal",
        createdAt: e.createdAt || Date.now()
      };
    }

    function loadCalEvents(){
      try{
        const raw = localStorage.getItem(LS_CAL_KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr)) return [];
        const out = [];
        for(const it of arr){
          const n = normalizeCalEvent(it);
          if(n && n.title) out.push(n);
        }
        return out;
      }catch{ return []; }
    }
    function saveCalEvents(events){
      localStorage.setItem(LS_CAL_KEY, JSON.stringify(events));
    }

    function getCalSinglesForDate(ymd){
      return loadCalEvents().filter(e => e.type === "single" && e.date === ymd);
    }
    function getCalRangesIntersecting(from,to){
      const r = clampRange(from,to);
      if(!r.from || !r.to) return [];
      return loadCalEvents().filter(e => e.type === "range" && !(e.to < r.from || e.from > r.to));
    }

    function deleteCalEventById(id){
      const all = loadCalEvents().filter(e => e.id !== id);
      saveCalEvents(all);
    }

    // -------------------------
    // Sync: calendar TODAY -> list (P1)
    // -------------------------
    function syncCalendarTodayToList(){
      const today = todayYMD();
      const allCal = loadCalEvents();

      const todaysSingles = allCal.filter(e => e.type==="single" && e.date===today);
      const todaysRanges  = allCal.filter(e => e.type==="range" && e.from <= today && e.to >= today);

      const list = loadListTasks();
      const existing = new Set(list.filter(x => x.source === "calendar" && x.calId).map(x => x.calId));

      let changed = false;

      function pushToListFromCal(e){
        if(existing.has(e.id)) return;
        list.push({
          id: "calcopy-" + e.id,
          calId: e.id,
          source: "calendar",
          title: e.title,
          mode: e.mode || "personal",
          priority: "P1",
          date: today,
          time: e.time || "",
          note: "",
          createdAt: Date.now(),
          done: false,
          doneAt: null
        });
        changed = true;
      }

      todaysSingles.forEach(pushToListFromCal);
      todaysRanges.forEach(pushToListFromCal);

      if(changed) saveListTasks(list);
    }

    // -------------------------
    // Tunnel
    // -------------------------
    const tunnel = document.getElementById("tunnel");
    const addFab = document.getElementById("btnAddFab");
    function setTunnelOriginFromEl(el){
      const r = el.getBoundingClientRect();
      const cx = r.left + r.width/2;
      const cy = r.top + r.height/2;
      const x = (cx / window.innerWidth) * 100;
      const y = (cy / window.innerHeight) * 100;
      tunnel.style.setProperty("--x", x.toFixed(2) + "%");
      tunnel.style.setProperty("--y", y.toFixed(2) + "%");
    }
    function diveToAdd(originEl){
      if(originEl) setTunnelOriginFromEl(originEl);
      else { tunnel.style.setProperty("--x","50%"); tunnel.style.setProperty("--y","50%"); }
      tunnel.classList.add("on");
      setTimeout(() => {
        tunnel.classList.remove("on");
        openAddPage();
      }, 360);
    }

    // -------------------------
    // LIST ADD
    // -------------------------
    const tTitle = document.getElementById("tTitle");
    const tDate = document.getElementById("tDate");
    const tTime = document.getElementById("tTime");
    const modePill = document.getElementById("modePill");
    const autoP1Note = document.getElementById("autoP1Note");

    let listAddMode = "personal";
    let listAddPrio = "P2";

    const togListMode = document.getElementById("togListMode");
    const togListModeV = document.getElementById("togListModeV");
    const togListPrio = document.getElementById("togListPrio");
    const togListPrioV = document.getElementById("togListPrioV");

    function renderListToggles(){
      togListModeV.textContent = (listAddMode === "business" ? "üíº V√ÅLL" : "üåø MAG√ÅN");
      togListPrioV.textContent = listAddPrio;
      modePill.textContent = "m√≥d: " + modeLabel(listAddMode);
    }
    function cycleListMode(){ listAddMode = (listAddMode === "business") ? "personal" : "business"; renderListToggles(); }
    function cycleListPrio(){ listAddPrio = (listAddPrio === "P1") ? "P2" : (listAddPrio === "P2" ? "P3" : "P1"); renderListToggles(); }
    togListMode.addEventListener("click", cycleListMode);
    togListPrio.addEventListener("click", cycleListPrio);

    function updateAutoP1Hint(){
      if(isTodayDate(tDate.value)){
        autoP1Note.innerHTML = "‚ö° Hat√°rid≈ë <b>ma</b> ‚Üí ment√©skor a priorit√°s automatikusan <b>P1</b> lesz.";
      } else autoP1Note.textContent = "";
    }
    tDate.addEventListener("change", updateAutoP1Hint);

    function clearForm(){
      tTitle.value = "";
      tTime.value = "";
      tDate.value = "";
      listAddPrio = "P2";
      listAddMode = currentMode;
      updateAutoP1Hint();
      renderListToggles();
      tTitle.focus();
    }
    function openAddPage(){
      listAddMode = currentMode;
      listAddPrio = "P2";
      renderListToggles();
      updateAutoP1Hint();
      show("add");
      setTimeout(()=> tTitle.focus(), 120);
    }
    function addListTask(){
      const title = (tTitle.value || "").trim();
      if(!title){
        tTitle.classList.add("danger");
        setTimeout(()=> tTitle.classList.remove("danger"), 520);
        tTitle.focus();
        return;
      }
      let pr = listAddPrio;
      if(isTodayDate(tDate.value)) pr = "P1";

      const task = {
        id: uid(),
        source: "list",
        title,
        mode: listAddMode,
        priority: pr,
        date: (tDate.value || ""),
        time: (tTime.value || ""),
        note: "",
        createdAt: Date.now(),
        done: false,
        doneAt: null
      };

      const tasks = loadListTasks();
      tasks.push(task);
      saveListTasks(tasks);

      currentMode = task.mode;
      renderList();
      show("list");
      clearForm();
    }

    document.getElementById("btnSaveTask").addEventListener("click", addListTask);
    document.getElementById("btnClearForm").addEventListener("click", clearForm);
    tTitle.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addListTask(); } });
    tTime.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addListTask(); } });

    // -------------------------
    // LIST VIEW
    // -------------------------
    const paperList = document.getElementById("paperList");
    const listModeIcon = document.getElementById("listModeIcon");
    const listModeLabel = document.getElementById("listModeLabel");
    const countNote = document.getElementById("countNote");

    const segBusiness = document.getElementById("segBusiness");
    const segPersonal = document.getElementById("segPersonal");

    function getTasksForMode(mode){
      purgeListDoneFromPreviousDays();
      syncCalendarTodayToList();
      const tasks = loadListTasks();
      return tasks.filter(t => t.mode === mode);
    }
    function sortListTasks(tasks){
      return tasks.slice().sort((a,b) => {
        const da = a.done ? 1 : 0;
        const db = b.done ? 1 : 0;
        if(da !== db) return da - db;
        const ra = priorityRank(a.priority);
        const rb = priorityRank(b.priority);
        if(ra !== rb) return ra - rb;
        const sa = dueStamp(a), sb = dueStamp(b);
        if(sa < sb) return -1;
        if(sa > sb) return 1;
        return (a.createdAt||0) - (b.createdAt||0);
      });
    }
    function setSegActive(){
      segBusiness.classList.toggle("active", currentMode === "business");
      segPersonal.classList.toggle("active", currentMode === "personal");
    }

    function renderList(){
      listModeIcon.textContent = modeIcon(currentMode);
      listModeLabel.textContent = modeLabel(currentMode);
      setSegActive();

      const all = getTasksForMode(currentMode);
      const tasks = sortListTasks(all);

      const doneCount = tasks.filter(t => t.done).length;
      const syncedCount = tasks.filter(t => t.source === "calendar").length;
      countNote.innerHTML = `<b>${tasks.length}</b> feladat ‚Ä¢ k√©sz: <b>${doneCount}</b> ‚Ä¢ napt√°rb√≥l: <b>${syncedCount}</b>`;

      if(tasks.length === 0){
        paperList.innerHTML = `
          <div class="smallNote">
            M√©g nincs feladat ebben a m√≥dban.<br/>
            Nyomd meg a <b>Ôºã Feladat</b> gombot.
          </div>
        `;
        return;
      }

      paperList.innerHTML = "";
      tasks.forEach(task => {
        const item = document.createElement("div");
        item.className = "paperItem" + (task.done ? " done" : "");
        item.setAttribute("data-id", task.id);

        const due = fmtDue(task);
        const ma = isTodayDate(task.date) ? `<span class="chip">MA</span>` : ``;
        const doneChip = task.done ? `<span class="chip">K√âSZ</span>` : ``;
        const srcChip = task.source === "calendar" ? `<span class="chip">üìÖ</span>` : ``;

        item.innerHTML = `
          <div class="dot"></div>
          <div class="paperText">
            <div class="paperTitle">${escapeHtml(task.title)}</div>
            <div class="paperMeta">
              <span>[${escapeHtml(task.priority)}]</span>
              <span>‚Ä¢</span>
              <span>hat√°rid≈ë: ${escapeHtml(due)}</span>
              ${ma}${doneChip}${srcChip}
            </div>
          </div>
          <button class="paperDel" data-del="${task.id}">T√∂rl√©s</button>
        `;
        paperList.appendChild(item);
      });

      paperList.querySelectorAll("[data-del]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const id = btn.getAttribute("data-del");
          const tasks = loadListTasks().filter(t => t.id !== id);
          saveListTasks(tasks);
          renderList();
        });
      });

      attachLongPressHandlers();
    }

    function toggleDone(taskId){
      const today = todayYMD();
      const tasks = loadListTasks();
      const idx = tasks.findIndex(t => t.id === taskId);
      if(idx < 0) return;
      const t = tasks[idx];
      t.done = !t.done;
      t.doneAt = t.done ? today : null;
      saveListTasks(tasks);
      renderList();
    }

    function attachLongPressHandlers(){
      const HOLD_MS = 550;
      paperList.querySelectorAll(".paperItem").forEach(el => {
        let timer = null;
        const id = el.getAttribute("data-id");

        const start = (e) => {
          if(e?.target && e.target.closest && e.target.closest(".paperDel")) return;
          el.classList.add("hold");
          timer = setTimeout(() => {
            el.classList.remove("hold");
            toggleDone(id);
          }, HOLD_MS);
        };

        const cancel = () => {
          if(timer) clearTimeout(timer);
          timer = null;
          el.classList.remove("hold");
        };

        el.addEventListener("mousedown", start);
        el.addEventListener("mouseup", cancel);
        el.addEventListener("mouseleave", cancel);
        el.addEventListener("mousemove", cancel);

        el.addEventListener("touchstart", (e) => { start(e); }, { passive: true });
        el.addEventListener("touchend", cancel, { passive: true });
        el.addEventListener("touchcancel", cancel, { passive: true });
      });
    }

    document.getElementById("btnClearAll").addEventListener("click", () => {
      const ok = confirm("Biztos t√∂rl√∂d az √∂sszes feladatot ebben a m√≥dban?");
      if(!ok) return;
      const remaining = loadListTasks().filter(t => t.mode !== currentMode);
      saveListTasks(remaining);
      renderList();
    });

    function enterMode(mode){
      currentMode = mode;
      renderList();
      show("list");
    }

    // -------------------------
    // CALENDAR
    // -------------------------
    const weekWide = document.getElementById("weekWide");
    const rangeLayer = document.getElementById("rangeLayer");
    const calWeekLabel = document.getElementById("calWeekLabel");
    const selDatePill = document.getElementById("selDatePill");
    const calDayTasks = document.getElementById("calDayTasks");
    const calSyncNote = document.getElementById("calSyncNote");

    const cTitle = document.getElementById("cTitle");
    const cTime = document.getElementById("cTime");
    const cDate = document.getElementById("cDate");
    const btnCalAddTask = document.getElementById("btnCalAddTask");
    const btnCalClear = document.getElementById("btnCalClear");

    let calWeekStart = mondayStart(new Date());
    let selectedDate = todayYMD();

    // Range mode inputs
    let rangeOn = false;
    const btnMultiToggle = document.getElementById("btnMultiToggle");
    const multiPanel = document.getElementById("multiPanel");
    const cFrom = document.getElementById("cFrom");
    const cTo = document.getElementById("cTo");

    // mode toggle
    let calAddMode = "personal";
    const togCalMode = document.getElementById("togCalMode");
    const togCalModeV = document.getElementById("togCalModeV");
    function renderCalToggle(){ togCalModeV.textContent = (calAddMode === "business" ? "üíº V√ÅLL" : "üåø MAG√ÅN"); }
    function cycleCalMode(){ calAddMode = (calAddMode === "business") ? "personal" : "business"; renderCalToggle(); }
    togCalMode.addEventListener("click", cycleCalMode);
    renderCalToggle();

    function formatHU(date, opts){ return date.toLocaleDateString("hu-HU", opts); }
    function mondayStart(d){
      const x = new Date(d);
      const day = x.getDay();
      const diff = (day === 0 ? -6 : 1) - day;
      x.setDate(x.getDate() + diff);
      x.setHours(0,0,0,0);
      return x;
    }

    // Toggle range UI
    btnMultiToggle.addEventListener("click", () => {
      rangeOn = !rangeOn;
      multiPanel.style.display = rangeOn ? "block" : "none";
      btnMultiToggle.textContent = rangeOn ? "‚úÖ T√∂bb nap" : "üìÜ T√∂bb nap";
      if(rangeOn){
        cFrom.value = selectedDate;
        cTo.value = selectedDate;
      }
      renderCalendarWeek();
    });

    function sortSingles(tasks){
      return tasks.slice().sort((a,b) => {
        const ta = (a.time && a.time.trim()) ? a.time : "99:99";
        const tb = (b.time && b.time.trim()) ? b.time : "99:99";
        if(ta < tb) return -1;
        if(ta > tb) return 1;
        return (a.createdAt||0) - (b.createdAt||0);
      });
    }

    function renderSelectedDayTasks(){
      const singles = sortSingles(getCalSinglesForDate(selectedDate));
      const ranges = getCalRangesIntersecting(selectedDate, selectedDate);

      selDatePill.textContent = "d√°tum: " + selectedDate;
      cDate.value = selectedDate;

      if(isTodayDate(selectedDate)){
        calSyncNote.innerHTML = "‚ö° Ez <b>ma</b>. Ment√©s ut√°n automatikusan felker√ºl a kiv√°lasztott list√°ra is.";
      } else {
        calSyncNote.textContent = "Ez a nap csak a napt√°rban √©l. A list√°ra csak a 'mai' ker√ºl automatikusan.";
      }

      const items = [];
      for(const r of ranges){
        items.push({ kind:"range", id:r.id, title:r.title, when:(r.time && r.time.trim()) ? r.time : "‚Äî" });
      }
      for(const s of singles){
        items.push({ kind:"single", id:s.id, title:s.title, when:(s.time && s.time.trim()) ? s.time : "‚Äî" });
      }

      if(items.length === 0){
        calDayTasks.innerHTML = `<div class="smallNote">Nincs feladat erre a napra.</div>`;
        return;
      }

      calDayTasks.innerHTML = "";
      for(const it of items){
        const el = document.createElement("div");
        el.className = "calTask";
        el.innerHTML = `
          <div class="t">${escapeHtml(it.title)}</div>
          <div class="m">
            <span>id≈ë: ${escapeHtml(it.when)}</span>
            <span>‚Ä¢</span>
            <span>${escapeHtml(it.kind === "range" ? "T√ñBB NAP" : "EGY NAP")}</span>
          </div>
          <button class="del" data-del="${it.id}">T√ñRL√âS</button>
        `;
        calDayTasks.appendChild(el);
      }

      calDayTasks.querySelectorAll("[data-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-del");
          deleteCalEventById(id);
          renderCalendarWeek();
          renderSelectedDayTasks();
          syncCalendarTodayToList();
        });
      });
    }

    // --- RANGE BARS LAYOUT ---
    function buildWeekDays(){
      const days = [];
      for(let i=0;i<7;i++){
        const d = new Date(calWeekStart);
        d.setDate(calWeekStart.getDate() + i);
        days.push(ymdOf(d));
      }
      return days;
    }

    function assignLanes(segments){
      const lanes = [];
      const placed = [];
      const sorted = segments.slice().sort((a,b)=> a.startCol - b.startCol || a.endCol - b.endCol);
      for(const seg of sorted){
        let laneIndex = -1;
        for(let i=0;i<lanes.length;i++){
          if(seg.startCol > lanes[i]) { laneIndex = i; break; }
        }
        if(laneIndex === -1){
          laneIndex = lanes.length;
          lanes.push(-1);
        }
        lanes[laneIndex] = Math.max(lanes[laneIndex], seg.endCol);
        placed.push({...seg, lane: laneIndex});
      }
      return {placed, laneCount: lanes.length};
    }

    function renderRangeBarsForWeek(weekFrom, weekTo){
      rangeLayer.innerHTML = "";
      const ranges = getCalRangesIntersecting(weekFrom, weekTo);

      if(ranges.length === 0){
        rangeLayer.style.display = "none";
        return;
      }
      rangeLayer.style.display = "grid";
      const days = buildWeekDays();
      const idxOf = new Map(days.map((d,i)=>[d,i]));

      const segments = [];
      for(const ev of ranges){
        const from = (ev.from < weekFrom) ? weekFrom : ev.from;
        const to   = (ev.to > weekTo) ? weekTo : ev.to;
        const startCol = idxOf.get(from);
        const endCol = idxOf.get(to);
        if(startCol == null || endCol == null) continue;
        segments.push({startCol, endCol, ev});
      }

      const {placed} = assignLanes(segments);
      rangeLayer.style.gridAutoRows = "42px";

      for(const seg of placed){
        const bar = document.createElement("div");
        bar.className = "rangeBar";
        bar.style.gridColumn = (seg.startCol+1) + " / " + (seg.endCol+2);
        bar.style.gridRow = (seg.lane+1) + " / " + (seg.lane+2);

        const when = seg.ev.time && seg.ev.time.trim() ? seg.ev.time : "";
        const meta = `${modeIcon(seg.ev.mode||"personal")} ${seg.ev.from}‚Äì${seg.ev.to}`;

        bar.innerHTML = `
          <div class="t">${escapeHtml(seg.ev.title)}</div>
          <div class="m">${escapeHtml(meta)}${when ? (" ‚Ä¢ " + escapeHtml(when)) : ""}</div>
        `;
        rangeLayer.appendChild(bar);
      }
    }

    function renderCalendarWeek(){
      weekWide.innerHTML = "";
      rangeLayer.innerHTML = "";

      const weekDays = buildWeekDays();
      const weekFrom = weekDays[0];
      const weekTo = weekDays[6];

      const weekLabelStart = parseYMD(weekFrom);
      const weekLabelEnd = parseYMD(weekTo);
      calWeekLabel.textContent =
        `${formatHU(weekLabelStart,{month:"long", day:"2-digit"})} ‚Äî ${formatHU(weekLabelEnd,{month:"long", day:"2-digit"})}`;

      renderRangeBarsForWeek(weekFrom, weekTo);

      for(let i=0;i<7;i++){
        const ymd = weekDays[i];
        const isToday = ymd === todayYMD();
        const isSel = ymd === selectedDate;

        const day = document.createElement("div");
        day.className = "dayWide" + (isToday ? " today" : "") + (isSel ? " sel" : "");
        day.setAttribute("data-ymd", ymd);

        const d = parseYMD(ymd);

        const head = document.createElement("div");
        head.className = "dayWideTop";
        head.innerHTML = `
          <div class="w">${formatHU(d,{weekday:"short"})}</div>
          <div class="d">${formatHU(d,{month:"2-digit", day:"2-digit"})}</div>
        `;
        day.appendChild(head);

        const taskWrap = document.createElement("div");
        taskWrap.style.display = "flex";
        taskWrap.style.flexDirection = "column";
        taskWrap.style.gap = "8px";
        day.appendChild(taskWrap);

        const singlesAll = sortSingles(getCalSinglesForDate(ymd));
        const total = singlesAll.length;

        singlesAll.forEach(t => {
          const block = document.createElement("div");
          block.className = "calTask";
          const when = (t.time && t.time.trim()) ? t.time : "‚Äî";
          block.innerHTML = `
            <div class="t">${escapeHtml(t.title)}</div>
            <div class="m"><span>${escapeHtml(when)}</span><span>‚Ä¢</span><span>${escapeHtml(modeIcon(t.mode||"personal"))}</span></div>
          `;
          taskWrap.appendChild(block);
        });

        const pill = document.createElement("div");
        pill.className = "miniPill";
        pill.textContent = total ? `${total} db` : `√ºres`;
        day.appendChild(pill);

        day.addEventListener("click", () => {
          selectedDate = ymd;
          renderCalendarWeek();
          renderSelectedDayTasks();
          setTimeout(()=> cTitle.focus(), 120);
        });

        day.addEventListener("dblclick", (e)=> { e.stopPropagation(); openDayView(ymd); });

        let lpTimer = null;
        day.addEventListener("touchstart", () => {
          lpTimer = setTimeout(()=> openDayView(ymd), 480);
        }, { passive:true });
        day.addEventListener("touchend", () => { if(lpTimer) clearTimeout(lpTimer); lpTimer=null; }, { passive:true });
        day.addEventListener("touchcancel", () => { if(lpTimer) clearTimeout(lpTimer); lpTimer=null; }, { passive:true });

        weekWide.appendChild(day);
      }
    }

    function openCalendar(){
      selectedDate = todayYMD();
      calWeekStart = mondayStart(new Date());
      rangeOn = false;
      multiPanel.style.display = "none";
      btnMultiToggle.textContent = "üìÜ T√∂bb nap";
      cDate.value = selectedDate;
      renderCalendarWeek();
      renderSelectedDayTasks();
      show("calendar");
      setTimeout(()=> cTitle.focus(), 150);
    }

    function clearCalForm(){
      cTitle.value = "";
      cTime.value = "";
      cDate.value = selectedDate;
      if(rangeOn){
        cFrom.value = selectedDate;
        cTo.value = selectedDate;
      }
      cTitle.focus();
    }
    btnCalClear.addEventListener("click", clearCalForm);

    function addCalendarEvent(){
      const title = (cTitle.value || "").trim();
      if(!title){
        cTitle.classList.add("danger");
        setTimeout(()=> cTitle.classList.remove("danger"), 520);
        cTitle.focus();
        return;
      }

      const all = loadCalEvents();
      const now = Date.now();

      if(rangeOn){
        const rr = clampRange((cFrom.value||"").trim(), (cTo.value||"").trim());
        if(!rr.from){
          cFrom.classList.add("danger");
          setTimeout(()=> cFrom.classList.remove("danger"), 520);
          cFrom.focus();
          return;
        }

        all.push({
          id: uid(),
          type: "range",
          title,
          from: rr.from,
          to: rr.to,
          time: (cTime.value || "").trim(),
          mode: calAddMode,
          createdAt: now
        });

        selectedDate = rr.from;
        calWeekStart = mondayStart(parseYMD(rr.from));
      } else {
        const date = (cDate.value || selectedDate || "").trim();
        if(!date){
          cDate.classList.add("danger");
          setTimeout(()=> cDate.classList.remove("danger"), 520);
          cDate.focus();
          return;
        }
        all.push({
          id: uid(),
          type: "single",
          title,
          date,
          time: (cTime.value || "").trim(),
          mode: calAddMode,
          createdAt: now
        });
        selectedDate = date;
      }

      saveCalEvents(all);

      renderCalendarWeek();
      renderSelectedDayTasks();
      syncCalendarTodayToList();

      cTitle.value = "";
      cTime.value = "";
      cTitle.focus();
    }

    btnCalAddTask.addEventListener("click", addCalendarEvent);
    cTitle.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addCalendarEvent(); } });
    cTime.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addCalendarEvent(); } });

    cDate.addEventListener("change", () => {
      if(cDate.value){
        selectedDate = cDate.value;
        renderCalendarWeek();
        renderSelectedDayTasks();
      }
    });

    document.getElementById("btnPrevWeek").addEventListener("click", () => {
      calWeekStart.setDate(calWeekStart.getDate() - 7);
      renderCalendarWeek();
    });
    document.getElementById("btnNextWeek").addEventListener("click", () => {
      calWeekStart.setDate(calWeekStart.getDate() + 7);
      renderCalendarWeek();
    });

    // -------------------------
    // Day View (06‚Äì22)
    // -------------------------
    const overlayDay = document.getElementById("overlayDay");
    const dayViewTitle = document.getElementById("dayViewTitle");
    const dayViewMeta = document.getElementById("dayViewMeta");
    const timelineBody = document.getElementById("timelineBody");
    const taskBlocks = document.getElementById("taskBlocks");
    const dayTaskList = document.getElementById("dayTaskList");
    document.getElementById("btnDayClose").addEventListener("click", () => overlayDay.classList.remove("on"));

    const DAY_START_H = 6;
    const DAY_END_H = 22;

    function ensureTimelineHours(){
      timelineBody.querySelectorAll(".hourRow").forEach(x=>x.remove());
      for(let h=DAY_START_H; h<=DAY_END_H; h++){
        const row = document.createElement("div");
        row.className = "hourRow";
        row.innerHTML = `
          <div class="hourLabel">${String(h).padStart(2,"0")}:00</div>
          <div class="hourLine"></div>
        `;
        timelineBody.appendChild(row);
      }
    }

    function timeToMinutes(t){
      if(!t || !t.trim()) return null;
      const m = /^(\d{1,2}):(\d{2})$/.exec(t.trim());
      if(!m) return null;
      const hh = Math.min(23, Math.max(0, parseInt(m[1],10)));
      const mm = Math.min(59, Math.max(0, parseInt(m[2],10)));
      return hh*60 + mm;
    }

    function openDayView(dateYMD){
      ensureTimelineHours();
      const dt = new Date(dateYMD + "T00:00:00");
      dayViewTitle.textContent = formatHU(dt, { year:"numeric", month:"long", day:"2-digit", weekday:"long" });
      dayViewMeta.textContent = dateYMD + (isTodayDate(dateYMD) ? " ‚Ä¢ MA" : "");

      const singles = sortSingles(getCalSinglesForDate(dateYMD));
      const ranges = getCalRangesIntersecting(dateYMD, dateYMD);

      const items = [];
      ranges.forEach(r => items.push({kind:"range", id:r.id, title:r.title, time:r.time||""}));
      singles.forEach(s => items.push({kind:"single", id:s.id, title:s.title, time:s.time||""}));

      if(items.length === 0){
        dayTaskList.innerHTML = `<div class="smallNote">Nincs feladat ezen a napon.</div>`;
      } else {
        dayTaskList.innerHTML = "";
        items.forEach(it => {
          const el = document.createElement("div");
          el.className = "calTask";
          const when = it.time && it.time.trim() ? it.time : "‚Äî";
          el.innerHTML = `
            <div class="t">${escapeHtml(it.title)}</div>
            <div class="m"><span>id≈ë: ${escapeHtml(when)}</span><span>‚Ä¢</span><span>${escapeHtml(it.kind==="range" ? "T√ñBB NAP" : "EGY NAP")}</span></div>
            <button class="del" data-del="${it.id}">T√ñRL√âS</button>
          `;
          dayTaskList.appendChild(el);
        });

        dayTaskList.querySelectorAll("[data-del]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-del");
            deleteCalEventById(id);
            renderCalendarWeek();
            renderSelectedDayTasks();
            openDayView(dateYMD);
            syncCalendarTodayToList();
          });
        });
      }

      taskBlocks.innerHTML = "";
      const hourHeight = 76;
      const pxPerMin = hourHeight / 60;
      const windowStartMin = DAY_START_H * 60;
      const windowEndMin = (DAY_END_H+1) * 60;

      const singlesTimed = singles.filter(t => timeToMinutes(t.time) != null);

      singlesTimed.forEach(t => {
        const mins = timeToMinutes(t.time);
        let posMin = mins;

        if(posMin < windowStartMin) posMin = windowStartMin;
        if(posMin > windowEndMin) posMin = windowEndMin;

        const relMin = posMin - windowStartMin;
        const top = relMin * pxPerMin;

        const block = document.createElement("div");
        block.className = "blockTask";
        block.style.top = top + "px";
        block.style.height = "56px";

        const when = t.time.trim();
        block.innerHTML = `
          <div class="t">${escapeHtml(t.title)}</div>
          <div class="m">
            <span>${escapeHtml(when)}</span>
            <span>‚Ä¢</span>
            <span>${escapeHtml(modeIcon(t.mode||"personal"))}</span>
          </div>
          <button class="del" data-del="${t.id}">T√ñRL√âS</button>
        `;
        taskBlocks.appendChild(block);
      });

      taskBlocks.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const id = btn.getAttribute("data-del");
          deleteCalEventById(id);
          renderCalendarWeek();
          renderSelectedDayTasks();
          openDayView(dateYMD);
          syncCalendarTodayToList();
        });
      });

      overlayDay.classList.add("on");
    }

    // -------------------------
    // Month picker
    // -------------------------
    const overlayMonths = document.getElementById("overlayMonths");
    const monthGrid = document.getElementById("monthGrid");
    document.getElementById("btnMonthsClose").addEventListener("click", ()=> overlayMonths.classList.remove("on"));

    function openMonthPicker(){
      monthGrid.innerHTML = "";
      const now = new Date();
      const y = now.getFullYear();
      const curM = now.getMonth();

      const monthNames = Array.from({length:12}, (_,i)=> {
        const d = new Date(y, i, 1);
        return d.toLocaleDateString("hu-HU",{month:"long"});
      });

      const t0 = document.createElement("div");
      t0.className = "monthTile current";
      t0.innerHTML = `
        <div class="m1">gyors</div>
        <div class="m2">Ugr√°s m√°ra</div>
        <div class="m3">${todayYMD()}</div>
      `;
      t0.addEventListener("click", ()=>{
        calWeekStart = mondayStart(new Date());
        selectedDate = todayYMD();
        renderCalendarWeek();
        renderSelectedDayTasks();
        overlayMonths.classList.remove("on");
      });
      monthGrid.appendChild(t0);

      for(let i=0;i<12;i++){
        const tile = document.createElement("div");
        tile.className = "monthTile" + (i === curM ? " current" : "");
        tile.innerHTML = `
          <div class="m1">${y}</div>
          <div class="m2">${monthNames[i]}</div>
          <div class="m3">h√≥nap</div>
        `;
        tile.addEventListener("click", ()=>{
          const first = new Date(y, i, 1);
          calWeekStart = mondayStart(first);
          selectedDate = ymdOf(first);
          renderCalendarWeek();
          renderSelectedDayTasks();
          overlayMonths.classList.remove("on");
        });
        monthGrid.appendChild(tile);
      }
      overlayMonths.classList.add("on");
    }
    document.getElementById("btnTodayMonth").addEventListener("click", openMonthPicker);

    // -------------------------
    // Navigation
    // -------------------------
    document.querySelectorAll(".card").forEach(card=>{
      const mode = card.getAttribute("data-mode");
      card.addEventListener("click", ()=> enterMode(mode));
      card.addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" ") enterMode(mode); });
    });

    document.getElementById("btnListBack").addEventListener("click", ()=> show("mode"));
    document.getElementById("btnCalHome").addEventListener("click", ()=> show("mode"));

    addFab.addEventListener("click", ()=> {
      setTunnelOriginFromEl(addFab);
      tunnel.classList.add("on");
      setTimeout(() => { tunnel.classList.remove("on"); openAddPage(); }, 360);
    });
    document.getElementById("btnListAdd").addEventListener("click", (e)=> diveToAdd(e.currentTarget));

    document.getElementById("btnListCalendar").addEventListener("click", openCalendar);
    document.getElementById("btnCalToList").addEventListener("click", ()=> { renderList(); show("list"); });

    document.getElementById("btnOpenCalendar").addEventListener("click", openCalendar);

    document.getElementById("btnAddBack").addEventListener("click", ()=> { renderList(); show("list"); });
    document.getElementById("btnToCalendarFromAdd").addEventListener("click", openCalendar);

    segBusiness.addEventListener("click", ()=> enterMode("business"));
    segPersonal.addEventListener("click", ()=> enterMode("personal"));

    // Init
    renderListToggles();
    updateAutoP1Hint();
    syncCalendarTodayToList();
    renderCalendarWeek();
    renderSelectedDayTasks();
  </script>


<script>
  // iOS Safari best-effort: if opened in browser (not from Home Screen), try to minimize address bar.
  // Full "standalone" requires: Megoszt√°s -> Hozz√°ad√°s a F≈ëk√©perny≈ëh√∂z, majd az ikonr√≥l ind√≠tsd.
  (function(){
    try{
      var isStandalone = false;
      if (window.matchMedia) isStandalone = window.matchMedia('(display-mode: standalone)').matches;
      if (!isStandalone && window.navigator && 'standalone' in window.navigator) isStandalone = !!window.navigator.standalone;
      if(!isStandalone){
        window.addEventListener('load', function(){ setTimeout(function(){ window.scrollTo(0, 1); }, 50); });
      }
    }catch(e){}
  })();
</script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }
</script>

</body>
</html>
